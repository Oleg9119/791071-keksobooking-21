(()=>{"use strict";window.onDocumentPressEsc=e=>{"Escape"===e.key&&(e.preventDefault(),window.card.closeCard(),window.closeErrorMessage(),window.closeSuccessMessage(),window.closeErrorUploadMessage())},window.onErrorButtonClick=()=>{document.querySelector(".error__button").removeEventListener("click",window.onErrorButtonClick),window.closeErrorUploadMessage()},window.onBodyClick=()=>{window.closeSuccessMessage(),window.closeErrorUploadMessage()},window.onClickCloseButton=()=>{window.card.closeCard()},window.setDisabledValue=(e,t)=>{const o=e.children;for(let e=0;e<o.length;e++)o[e].disabled=t},(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector(".ad-form__field input[type=file]"),o=document.querySelector(".ad-form-header__preview img"),n=document.querySelector(".ad-form__upload input[type=file]"),r=document.querySelector(".ad-form__photo");t.addEventListener("change",(()=>{const n=t.files[0],r=n.name.toLowerCase();if(e.some((e=>r.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{o.src=e.result})),e.readAsDataURL(n)}})),n.addEventListener("change",(()=>{const t=n.files[0],o=t.name.toLowerCase();if(e.some((e=>o.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{const t=document.createElement("img");t.style.width="70px",t.style.height="70px",t.src=e.result,r.appendChild(t)})),e.readAsDataURL(t)}}))})(),(()=>{let e;window.debounce=function(t){e&&window.clearTimeout(e),e=window.setTimeout(t,500)}})(),window.closeErrorMessage=()=>{document.removeEventListener("keydown",window.onDocumentPressEsc);const e=document.querySelector(".downloadError");e&&e.parentNode.removeChild(e)},window.closeSuccessMessage=()=>{document.removeEventListener("keydown",window.onDocumentPressEsc),document.removeEventListener("click",window.onBodyClick);const e=document.querySelector(".success");e&&e.parentNode.removeChild(e)},window.closeErrorUploadMessage=()=>{document.removeEventListener("keydown",window.onDocumentPressEsc),document.removeEventListener("click",window.onBodyClick);const e=document.querySelector(".error");e&&e.parentNode.removeChild(e)},(()=>{const e=document.querySelector(".ad-form"),t=document.querySelector(".map__filters");let o;window.onLoad={showPins:n=>{o=n.filter((e=>!!e.offer)),window.form.activate(),window.setDisabledValue(t,!1),window.setDisabledValue(e,!1),window.map.activateMap(),window.form.setAddress(),window.map.createAds(n)},getAllAds:()=>o}})(),window.onError=()=>{const e=document.querySelector("main"),t=document.querySelector("#downloadError").content.querySelector(".downloadError").cloneNode(!0);t.querySelector(".downloadError__message").textContent="Ошибка загрузки данных",e.appendChild(t),document.addEventListener("keydown",window.onDocumentPressEsc)},window.onUploadSuccess=()=>{const e=document.querySelector("main"),t=document.querySelector("#success").content.querySelector(".success").cloneNode(!0);e.appendChild(t),document.addEventListener("keydown",window.onDocumentPressEsc),document.addEventListener("click",window.onBodyClick)},window.onUploadError=()=>{const e=document.querySelector("main"),t=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),o=t.querySelector(".error__button");e.appendChild(t),o.addEventListener("click",window.onErrorButtonClick),document.addEventListener("keydown",window.onDocumentPressEsc),document.addEventListener("click",window.onBodyClick)},window.upload=(e,t)=>{const o=new XMLHttpRequest;o.responseType="json",o.addEventListener("load",(()=>{t(o.response),window.onUploadSuccess()})),o.addEventListener("error",(()=>{window.onUploadError()})),o.open("POST","https://21.javascript.pages.academy/keksobooking"),o.send(e)},window.download=(e,t)=>{const o=new XMLHttpRequest;o.responseType="json",o.open("GET","https://21.javascript.pages.academy/keksobooking/data"),o.addEventListener("load",(()=>{e(o.response)})),o.addEventListener("error",(()=>{t()})),o.send()},(()=>{const e={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},t=document.querySelector(".map"),o=(e,t,o)=>t?o(e):e.remove();window.card={createCard:t=>{const n=document.querySelector(".map__filters-container"),r=document.querySelector("#card").content.querySelector(".map__card").cloneNode(!0),a=r.querySelector(".popup__title"),d=r.querySelector(".popup__text--address"),i=r.querySelector(".popup__text--price"),s=r.querySelector(".popup__type"),c=r.querySelector(".popup__text--capacity"),l=r.querySelector(".popup__text--time"),u=r.querySelector(".popup__features"),p=r.querySelector(".popup__description"),w=r.querySelector(".popup__photos"),m=r.querySelector(".popup__avatar");o(a,t.offer.title,(e=>{e.textContent=`${t.offer.title}`})),o(d,t.offer.address,(e=>{e.textContent=`${t.offer.address}`})),o(i,t.offer.price,(e=>{e.textContent=`${t.offer.price}₽/ночь`})),o(s,t.offer.type,(o=>{var n;o.textContent=`${n=t.offer.type,e[n]}`})),o(c,t.offer.rooms&&t.offer.guests,(e=>{e.textContent=`${t.offer.rooms} комнаты для ${t.offer.guests} гостей`})),o(l,t.offer.checkin&&t.offer.checkout,(e=>{e.textContent=`Заезд после ${t.offer.checkin}, выезд до ${t.offer.checkout}`})),o(u,t.offer.features.length,(e=>{e.textContent=`${t.offer.features}`})),o(p,t.offer.description,(e=>{e.textContent=`${t.offer.description}`})),o(w,t.offer.photos.length,(e=>{const o=((e,t)=>{const o=document.createDocumentFragment(),n=e.querySelector("img");e.removeChild(n);for(let e=0;e<t.length;e++){const r=n.cloneNode(!0);r.src=`${t[e]}`,o.appendChild(r)}return o})(e,t.offer.photos);e.appendChild(o)})),o(m,t.author.avatar,(e=>{e.src=`${t.author.avatar}`})),n.appendChild(r)},closeCard:()=>{document.removeEventListener("keydown",window.onDocumentPressEsc);const e=t.querySelector(".map__card");e&&e.parentNode.removeChild(e)}}})(),window.getPin=e=>{const t=document.querySelector("#pin").content.querySelector(".map__pin").cloneNode(!0),o=t.querySelector("img");return t.style.left=e.location.x-25+"px",t.style.top=e.location.y-70+"px",o.src=`${e.author.avatar}`,o.alt=`${e.offer.title}`,t.addEventListener("click",(t=>{window.card.closeCard(),window.card.createCard(e),window.map.activatePin(t.currentTarget),document.addEventListener("keydown",window.onDocumentPressEsc),document.querySelector(".popup__close").addEventListener("click",window.onClickCloseButton)})),t},(()=>{const e={WIDTH:65,HEIGHT:65,TIP_HEIGHT:22};window.map={activateMap:()=>{document.querySelector(".map").classList.remove("map--faded")},createAds:e=>{const t=document.querySelector(".map__pins"),o=document.createDocumentFragment(),n=e.length<5?e.length:5;for(let t=0;t<n;t++){const n=window.getPin(e[t]);o.appendChild(n)}t.appendChild(o)},activatePin:e=>{const t=document.querySelector(".map__pin--active");t&&t.classList.remove("map__pin--active"),e.classList.add("map__pin--active")},removePins:()=>{const e=document.querySelectorAll(".map__pin:not(.map__pin--main)");for(let t=0;t<e.length;t++)e[t].remove()},getMainPinSize:()=>e}})(),(()=>{const e="570px",t="375px",o=window.map.getMainPinSize().WIDTH/2,n=window.map.getMainPinSize().HEIGHT/2,r=window.map.getMainPinSize().WIDTH/2,a=window.map.getMainPinSize().HEIGHT+window.map.getMainPinSize().TIP_HEIGHT,d=document.querySelector(".ad-form"),i=d.querySelector("input[name='address']"),s=document.querySelector(".map__pin--main"),c=document.querySelector(".map__filters"),l=()=>{(()=>{const o=document.querySelector(".map"),n=o.querySelector(".map__card"),r=o.querySelectorAll(".map__pin:not(.map__pin--main)");o.classList.add("map--faded"),n&&(n.style.display="none"),s.style.left=e,s.style.top=t;for(let e=0;e<r.length;e++)r[e].style.display="none"})(),window.setDisabledValue(c,!0),window.setDisabledValue(d,!0),window.form.deactivate()};window.form={setAddress:()=>{const e=parseInt(s.style.left,10)+o,t=parseInt(s.style.top,10)+n,c=parseInt(s.style.left,10)+r,l=parseInt(s.style.top,10)+a;d.classList.contains("ad-form--disabled")?i.placeholder=`${parseInt(e,10)}, ${parseInt(t,10)}`:i.value=`${parseInt(c,10)}, ${parseInt(l,10)}`},activate:()=>{g(),d.classList.remove("ad-form--disabled")},deactivate:()=>{c.reset(),d.reset(),d.classList.add("ad-form--disabled")}};const u=d.querySelector("#title"),p=d.querySelector("#type"),w=d.querySelector("#price"),m=d.querySelector("#room_number"),y=d.querySelector("#capacity"),f=d.querySelector("#timein"),v=d.querySelector("#timeout");u.addEventListener("input",(e=>{var t;t=e.target,u.value.length>=100?t.setCustomValidity("Заголовок объявления не должен превышать 100 символов"):t.setCustomValidity("")}));const g=()=>{const e=m.value,t=y.value;t>e?y.setCustomValidity("Количество гостей не должно превышать количество комнат"):"100"===e&&"0"!==t?m.setCustomValidity("100 комнат не предназначены для гостей"):"100"!==e&&"0"===t?m.setCustomValidity("Не для гостей предназначены только 100 комнат"):(y.setCustomValidity(""),m.setCustomValidity(""))};m.addEventListener("change",(()=>{g()})),y.addEventListener("change",(()=>{g()})),p.addEventListener("change",(e=>{"flat"===e.target.value?(w.min=1e3,w.placeholder="1000"):"bungalow"===e.target.value?(w.min=0,w.placeholder="0"):"house"===e.target.value?(w.min=5e3,w.placeholder="5000"):"palace"===e.target.value&&(w.min=1e4,w.placeholder="10000")})),f.addEventListener("change",(e=>{"12:00"===e.target.value?v.value="12:00":"13:00"===e.target.value?v.value="13:00":"14:00"===e.target.value&&(v.value="14:00")})),v.addEventListener("change",(e=>{"12:00"===e.target.value?f.value="12:00":"13:00"===e.target.value?f.value="13:00":"14:00"===e.target.value&&(f.value="14:00")})),d.addEventListener("submit",(e=>{e.preventDefault(),window.upload(new FormData(d),(()=>{l()}))})),d.addEventListener("reset",(()=>{l(),w.placeholder="1000"})),window.form.setAddress()})(),(()=>{const e=document.querySelector(".map__filters"),t=e.querySelector("#housing-type"),o=e.querySelector("#housing-price"),n=e.querySelector("#housing-rooms"),r=e.querySelector("#housing-guests"),a=e.querySelector("#housing-features"),d=a.querySelector("#filter-wifi"),i=a.querySelector("#filter-dishwasher"),s=a.querySelector("#filter-parking"),c=a.querySelector("#filter-washer"),l=a.querySelector("#filter-elevator"),u=a.querySelector("#filter-conditioner"),p={type:"any",price:"any",rooms:"any",guests:"any",features:new Set},w={"housing-type":"type","housing-price":"price","housing-rooms":"rooms","housing-guests":"guests","filter-wifi":"wifi","filter-dishwasher":"dishwasher","filter-parking":"parking","filter-washer":"washer","filter-elevator":"elevator","filter-conditioner":"conditioner"},m=(e,t,o)=>e===o||t.toString()===e,y=(e,t)=>{switch(e){case"any":return!0;case"low":return t<1e4;case"middle":return t>=1e4&&t<5e4;case"high":return t>=5e4;default:return!1}},f=(e,t)=>[...e].every((e=>t.includes(e))),v=()=>{window.map.removePins(),window.card.closeCard();const e=[],t=window.onLoad.getAllAds();for(let o=0;o<t.length&&!(e.length>=5);o++)m(p.type,t[o].offer.type,"any")&&m(p.rooms,t[o].offer.rooms,"any")&&m(p.guests,t[o].offer.guests,"any")&&y(p.price,t[o].offer.price)&&f(p.features,t[o].offer.features)&&e.push(t[o]);window.map.createAds(e)},g=e=>{const t=w[e.target.name];p[t]=e.target.value,window.debounce(v)},S=e=>{const t=w[e.target.id];var o,n;p[t]=e.target.id,n=t,(o=p.features).has(n)?o.delete(n):o.add(n),window.debounce(v)};t.addEventListener("change",g),o.addEventListener("change",g),n.addEventListener("change",g),r.addEventListener("change",g),d.addEventListener("change",S),i.addEventListener("change",S),s.addEventListener("change",S),c.addEventListener("change",S),l.addEventListener("change",S),u.addEventListener("change",S)})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pin--main"),o=130-(window.map.getMainPinSize().HEIGHT+window.map.getMainPinSize().TIP_HEIGHT),n=630-(window.map.getMainPinSize().HEIGHT+window.map.getMainPinSize().TIP_HEIGHT),r=0-window.map.getMainPinSize().WIDTH/2,a=1200-window.map.getMainPinSize().WIDTH/2;t.addEventListener("mousedown",(d=>{d.preventDefault();const i=e.getBoundingClientRect(),s=e=>{e.preventDefault();const d=e.clientX-i.x-window.map.getMainPinSize().WIDTH/2,s=e.clientY-i.y-window.map.getMainPinSize().HEIGHT/2;t.style.left=d<r?r+"px":d>a?a+"px":d+"px",t.style.top=s<o?o+"px":s>n?n+"px":s+"px",window.form.setAddress()},c=e=>{e.preventDefault(),document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",c)};document.addEventListener("mousemove",s),document.addEventListener("mouseup",c)}))})(),(()=>{const e=document.querySelector(".ad-form"),t=document.querySelector(".map__pin--main"),o=document.querySelector(".map__filters");t.addEventListener("click",(()=>{window.download(window.onLoad.showPins,window.onError)})),window.setDisabledValue(o,!0),window.setDisabledValue(e,!0)})()})();